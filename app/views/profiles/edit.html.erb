<div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6 mt-10">
  <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Edit Profile</h2>

  <%= form_with model: @profile, url: profile_path, local: true, html: { multipart: true, class: "space-y-6" } do |f| %>
    <div class="flex flex-col items-center">
      <div class="relative mb-4">
        <% if @profile.avatar.attached? %>
          <%= image_tag @profile.avatar,
                        class: "rounded-full h-32 w-32 object-cover border-4 border-white shadow-lg",
                        id: "avatar-preview" %>
        <% else %>
          <div class="rounded-full h-32 w-32 bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center border-4 border-white shadow-lg">
            <span class="text-gray-500 text-sm">Add Photo</span>
          </div>
        <% end %>
        <label for="profile_avatar" class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full p-2 cursor-pointer shadow-md hover:bg-blue-600 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </label>
        <%= f.file_field :avatar, class: "hidden", id: "profile_avatar", accept: "image/*" %>
      </div>
      <!-- Input Fields -->
      <div class="w-full space-y-4">
        <%= f.label :first_name, class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_field :first_name, class: "form-input block w-full rounded-md border-gray-300 shadow-sm focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %>

        <%= f.label :last_name, class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_field :last_name, class: "form-input block w-full rounded-md border-gray-300 shadow-sm focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %>

        <%= f.select :country, [], { include_blank: 'Select country', selected: @profile.country },
                     class: "form-input block w-full rounded-md border-gray-300 shadow-sm focus:ring focus:ring-indigo-200 focus:ring-opacity-50",
                     data: {
                       location_target: "countrySelect",
                       selected: @profile.country
                     } %>

        <%= f.select :city, [], { include_blank: 'Select city', selected: @profile.city },
                     class: "form-input block w-full rounded-md border-gray-300 shadow-sm focus:ring focus:ring-indigo-200 focus:ring-opacity-50",
                     data: {
                       location_target: "citySelect",
                       selected: @profile.city
                     } %>

        <%= f.label :bio, class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_area :bio, rows: 3, class: "form-input block w-full rounded-md border-gray-300 shadow-sm focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="flex justify-between pt-6">
      <%= link_to "Cancel", profile_path,
                  class: "px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition" %>
      <%= f.submit "Save Changes",
                   class: "px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition cursor-pointer",
                   data: { disable_with: "Saving..." } %>
    </div>
  <% end %>
</div>

<script>
    document.addEventListener('turbo:load', setupAvatarPreview);
    document.addEventListener('turbo:render', setupAvatarPreview);

    function setupAvatarPreview() {
        const avatarInput = document.getElementById('profile_avatar');
        const avatarPreview = document.getElementById('avatar-preview');

        if (avatarInput && !avatarInput._listenerAttached) {
            avatarInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file && file.type.match('image.*')) {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        if (avatarPreview) {
                            avatarPreview.src = e.target.result;
                        } else {
                            const previewContainer = document.querySelector('.relative.mb-4');
                            if (previewContainer) {
                                const newAvatar = document.createElement('img');
                                newAvatar.src = e.target.result;
                                newAvatar.classList.add("rounded-full", "h-32", "w-32", "object-cover", "border-4", "border-white", "shadow-lg");
                                newAvatar.id = "avatar-preview";
                                previewContainer.innerHTML = '';
                                previewContainer.appendChild(newAvatar);
                            }
                        }
                    };

                    reader.readAsDataURL(file);
                }
            });

            avatarInput._listenerAttached = true;
        }
    }
</script>
